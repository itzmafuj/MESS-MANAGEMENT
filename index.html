<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mess Manager Pro 2026</title>
    <style>
        :root {
            --primary: #6366f1; --secondary: #10b981; --danger: #f43f5e;
            --warning: #f59e0b; --dark: #1e293b; --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background: #e2e8f0; color: var(--dark); margin: 0; min-height: 100vh; }
        #login-screen { position: fixed; inset: 0; background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: var(--glass); padding: 2.5rem; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        nav { background: var(--glass); backdrop-filter: blur(10px); padding: 0.75rem; display: flex; gap: 10px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); overflow-x: auto; }
        nav button { padding: 0.8rem 1.2rem; border: none; border-radius: 12px; background: transparent; color: #64748b; font-weight: 600; cursor: pointer; white-space: nowrap; }
        nav button.active { background: var(--primary); color: white; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: var(--glass); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { padding: 1rem; border-radius: 16px; color: white; text-align: center; }
        .blue { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .green { background: linear-gradient(135deg, #10b981, #059669); }
        .gold { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .red { background: linear-gradient(135deg, #f43f5e, #e11d48); }
        .table-wrap { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f1f5f9; color: #475569; padding: 1rem; text-align: left; font-size: 0.85rem; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; }
        .edit-input { width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 1rem; box-sizing: border-box; }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-del { background: #fee2e2; color: var(--danger); padding: 5px 10px; font-size: 0.75rem; border:none; border-radius:4px; cursor:pointer; }
        .status-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: block; margin-top: 4px; text-align: center; }
        .hidden { display: none !important; }
        .meal-main { font-size: 1.1rem; font-weight: 700; color: var(--dark); }
        .meal-sub { font-size: 0.75rem; color: #64748b; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2 style="color:var(--primary); margin-bottom: 1.5rem;">Mess Manager 2026</h2>
        <input type="password" id="pass" placeholder="Enter Access Key" oninput="autoLogin()" class="edit-input">
        <button class="btn btn-primary" onclick="checkLogin()">Unlock System</button>
    </div>
</div>

<div id="app" style="display:none;">
    <nav>
        <button id="nav-dashboard" class="active" onclick="showTab('dashboard', this)">Dashboard</button>
        <button id="nav-meals" onclick="showTab('meals', this)">Meal History</button>
        <button id="nav-bazar" onclick="showTab('bazar', this)">Bazar List</button>
        <button id="nav-members" onclick="showTab('members', this)">Members</button>
        <button id="nav-settings" class="admin-only hidden" onclick="showTab('settings', this)">Settings</button>
    </nav>

    <div class="container">
        <div id="tab-dashboard" class="tab-content">
            <div class="card">
                <div style="display: flex; gap: 10px;">
                    <select id="filter-month" class="edit-input" onchange="refreshUI()" style="margin:0">
                        <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                        <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                        <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                        <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                    </select>
                    <select id="filter-year" class="edit-input" onchange="refreshUI()" style="margin:0">
                        <option value="2025">2025</option><option value="2026">2026</option>
                    </select>
                </div>
            </div>
            <div class="card">
                <h2 style="text-align:center; color:var(--primary); margin-top:0">Monthly Summary</h2>
                <p id="logic-indicator" style="font-size: 0.75rem; text-align: center; color: #64748b; margin-top: -10px; font-weight: bold;"></p>
                <div class="grid-stats">
                    <div class="stat-box blue"><span>Billable Meals</span><h2 id="stat-meals">0</h2></div>
                    <div class="stat-box green"><span>Total Cost</span><h2 id="stat-cost">₹0</h2></div>
                    <div class="stat-box gold" id="balance-card"><span>Available</span><h2 id="stat-balance">₹0</h2></div>
                    <div class="stat-box red"><span>Rate</span><h2 id="stat-rate">₹0</h2></div>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Member</th><th>Deposit</th><th>Meal (Act/Min)</th><th>Cost</th><th>Status</th></tr></thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
            <button class="btn btn-primary" style="background:#64748b; margin-top:10px" onclick="logout()">Logout</button>
        </div>

        <div id="tab-meals" class="tab-content hidden">
            <div class="card admin-only hidden" id="admin-meal-entry">
                <h3>Record Meals</h3>
                <input type="date" id="meal-date" class="edit-input">
                <div id="meal-inputs-area"></div>
                <button class="btn btn-primary" onclick="saveDailyMeals()">Save Record</button>
            </div>
            <div class="card"><div class="table-wrap"><table><thead id="meal-history-head"></thead><tbody id="meal-history-body"></tbody></table></div></div>
        </div>

        <div id="tab-bazar" class="tab-content hidden">
            <div class="card admin-only hidden">
                <h3>Add Expense</h3>
                <input type="date" id="b-date" class="edit-input"><input type="number" id="b-amt" placeholder="Amount" class="edit-input"><input type="text" id="b-note" placeholder="Item" class="edit-input"><button class="btn btn-primary" style="background:var(--secondary)" onclick="addBazar()">Add</button>
            </div>
            <div class="card"><div class="table-wrap"><table><tbody id="bazar-body"></tbody></table></div></div>
        </div>

        <div id="tab-members" class="tab-content hidden">
            <div class="card admin-only hidden">
                <h3>New Member / Deposit</h3>
                <input type="text" id="new-mem-name" class="edit-input" placeholder="Name"><input type="number" id="new-mem-min" class="edit-input" placeholder="Min Meal" value="50"><button class="btn btn-primary" style="background:var(--secondary)" onclick="addMember()">Create</button>
                <hr style="margin:1.5rem 0">
                <input type="date" id="dep-date" class="edit-input"><select id="dep-member" class="edit-input"></select><input type="number" id="dep-amt" placeholder="Deposit Amount" class="edit-input"><button class="btn btn-primary" onclick="addDeposit()">Save</button>
            </div>
            <div class="card"><h3>Member List</h3><div class="table-wrap"><table><tbody id="member-list-body"></tbody></table></div></div>
            <div class="card"><h3>Recent Deposits</h3><div class="table-wrap"><table><tbody id="deposit-history-body"></tbody></table></div></div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <div class="card"><h3>Cloud Keys</h3><label>Admin Key</label><input type="text" id="set-admin-key" class="edit-input"><label>Viewer Key</label><input type="text" id="set-viewer-key" class="edit-input"><button class="btn btn-primary" onclick="updateKeys()">Save Keys</button></div>
        </div>
    </div>
</div>

<script>
    let isAdmin = false;
    let keys = JSON.parse(localStorage.getItem('messKeys')) || { admin: "MESS2026", viewer: "MESSMEAL" };
    let data = { members: [], meals: {}, bazar: [], deposits: [], keys: keys };
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnfWzHfN2qBGw68lOkTttSZ3Mz3D0T274",
        authDomain: "messmenegment.firebaseapp.com",
        databaseURL: "https://messmenegment-default-rtdb.firebaseio.com",
        projectId: "messmenegment",
        storageBucket: "messmenegment.firebasestorage.app",
        messagingSenderId: "365715103776",
        appId: "1:365715103776:web:32af4ed2537cb806341c45",
        measurementId: "G-53L55JYM5W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, 'messData');

    onValue(dataRef, (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData) {
            data = cloudData;
            if (data.keys) { keys = data.keys; localStorage.setItem('messKeys', JSON.stringify(keys)); }
            window.refreshUI();
        }
    });

    window.save = function() {
        if(!isAdmin) return;
        data.keys = keys;
        set(dataRef, data).catch(err => alert("Error: " + err.message));
        window.refreshUI();
    };

    window.refreshUI = function() {
        const sBody = document.getElementById('summary-body');
        if(!sBody) return;

        const selMonth = document.getElementById('filter-month').value;
        const selYear = document.getElementById('filter-year').value;
        const filterStr = `${selYear}-${selMonth}`;
        
        const lastDayDate = new Date(selYear, selMonth, 0); 
        const lastDayString = `${selYear}-${selMonth}-${String(lastDayDate.getDate()).padStart(2, '0')}`;
        const isMonthFinished = data.meals && data.meals[lastDayString];

        document.getElementById('logic-indicator').innerText = isMonthFinished ? "Month Finished: Min Rule Applied" : "Month in Progress: Showing Actual";

        let totalBillable = 0, mActualCounts = {}, mDepsSum = {}, periodIncome = 0;
        (data.members || []).forEach(m => { mActualCounts[m.id] = 0; mDepsSum[m.id] = 0; });
        (data.deposits || []).forEach(d => { if(d.date.startsWith(filterStr)) { mDepsSum[d.mId] += parseFloat(d.amt); periodIncome += parseFloat(d.amt); } });
        
        if (data.meals) {
            Object.entries(data.meals).forEach(([date, entry]) => {
                if(date.startsWith(filterStr)) {
                    Object.entries(entry).forEach(([id, qty]) => { if(mActualCounts[id] !== undefined) mActualCounts[id] += parseFloat(qty); });
                }
            });
        }

        const calcData = (data.members || []).map(m => {
            const actual = mActualCounts[m.id] || 0;
            const minSet = m.minMeal || 50;
            const billable = isMonthFinished ? (actual <= minSet ? minSet : actual) : actual;
            totalBillable += billable;
            return { ...m, actual, billable, minSet };
        });

        const totalBazar = (data.bazar || []).reduce((sum, b) => b.date.startsWith(filterStr) ? sum + parseFloat(b.amt) : sum, 0);
        const rate = totalBillable > 0 ? totalBazar / totalBillable : 0;
        const avail = periodIncome - totalBazar;

        document.getElementById('stat-meals').innerText = totalBillable.toFixed(1);
        document.getElementById('stat-cost').innerText = "₹" + totalBazar.toFixed(0);
        document.getElementById('stat-balance').innerText = "₹" + avail.toFixed(0);
        document.getElementById('stat-rate').innerText = "₹" + rate.toFixed(2);
        document.getElementById('balance-card').style.background = avail < 0 ? 'var(--danger)' : 'var(--warning)';

        sBody.innerHTML = calcData.map(m => {
            const cost = m.bill * rate;
            const net = (m.billable * rate) - mDepsSum[m.id];
            return `<tr><td><b>${m.name}</b></td><td>₹${mDepsSum[m.id]}</td><td><div class="meal-main">${m.actual} / ${m.minSet}</div><div class="meal-sub">Bill: ${m.billable}</div></td><td>₹${(m.billable * rate).toFixed(1)}</td><td style="color:${net > 0 ? 'red' : 'green'}"><b>₹${Math.abs(net).toFixed(1)}</b><span class="status-badge" style="background:${net > 0 ? '#fee2e2' : '#d1fae5'}">${net > 0 ? 'DUE' : 'SURPLUS'}</span></td></tr>`;
        }).join('');

        document.getElementById('dep-member').innerHTML = (data.members || []).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        if(isAdmin) {
            document.getElementById('meal-inputs-area').innerHTML = (data.members || []).map(m => `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; background:#f1f5f9; padding:10px; border-radius:10px"><b>${m.name}</b><input type="number" class="day-meal-val edit-input" style="width:80px; margin:0; text-align:center" data-id="${m.id}" step="0.5" value="0"></div>`).join('');
        }
        
        const mDates = Object.keys(data.meals || {}).sort().reverse();
        document.getElementById('meal-history-head').innerHTML = `<tr><th>Date</th>${(data.members || []).map(m => `<th>${m.name.substring(0,3)}</th>`).join('')}${isAdmin ? '<th>X</th>' : ''}</tr>`;
        document.getElementById('meal-history-body').innerHTML = mDates.map(d => `<tr><td><small>${d}</small></td>${(data.members || []).map(m => `<td>${data.meals[d][m.id] || 0}</td>`).join('')}${isAdmin ? `<td><button class="btn-del" onclick="delMealDate('${d}')">X</button></td>` : ''}</tr>`).join('');
        document.getElementById('bazar-body').innerHTML = (data.bazar || []).slice().reverse().map((b, i) => `<tr><td>${b.date}</td><td>${b.note}</td><td>₹${b.amt}</td>${isAdmin ? `<td><button class="btn-del" onclick="delBazar(${data.bazar.length-1-i})">X</button></td>` : ''}</tr>`).join('');
        document.getElementById('member-list-body').innerHTML = (data.members || []).map((m, i) => `<tr><td>${m.name}</td><td>Min: ${m.minMeal}</td>${isAdmin ? `<td><button class="btn-del" onclick="delMember(${i})">X</button></td>` : ''}</tr>`).join('');
        document.getElementById('deposit-history-body').innerHTML = (data.deposits || []).slice().reverse().map((d, i) => {
            const m = data.members.find(mem => mem.id == d.mId);
            return `<tr><td>${d.date}</td><td>${m ? m.name : '?'}</td><td>₹${d.amt}</td>${isAdmin ? `<td><button class="btn-del" onclick="delDep(${data.deposits.length-1-i})">X</button></td>` : ''}</tr>`;
        }).join('');
    };

    window.showTab = function(id, btn) { document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); window.refreshUI(); };
    window.login = function(key) { isAdmin = (key === keys.admin); localStorage.setItem('isLoggedIn', 'true'); localStorage.setItem('userRole', isAdmin ? 'admin' : 'viewer'); document.getElementById('login-screen').style.display = 'none'; document.getElementById('app').style.display = 'block'; document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin)); window.refreshUI(); };
    window.autoLogin = function() { const v = document.getElementById('pass').value.toUpperCase(); if(v === keys.admin || v === keys.viewer) window.login(v); };
    window.checkLogin = function() { const v = document.getElementById('pass').value.toUpperCase(); if(v === keys.admin || v === keys.viewer) window.login(v); else alert("Wrong Key"); };
    window.logout = function() { localStorage.removeItem('isLoggedIn'); location.reload(); };
    window.saveDailyMeals = function() { if(!isAdmin) return; const d = document.getElementById('meal-date').value; if(!d) return alert("Select Date"); const entry = {}; document.querySelectorAll('.day-meal-val').forEach(i => entry[i.dataset.id] = parseFloat(i.value) || 0); data.meals[d] = entry; window.save(); };
    window.delMealDate = function(d) { if(!isAdmin) return; if(confirm("Delete?")) { delete data.meals[d]; window.save(); } };
    window.addBazar = function() { if(!isAdmin) return; const d = document.getElementById('b-date').value, a = document.getElementById('b-amt').value; if(d && a) { data.bazar.push({amt: parseFloat(a), note: document.getElementById('b-note').value, date: d}); window.save(); } };
    window.addDeposit = function() { if(!isAdmin) return; const d = document.getElementById('dep-date').value, m = document.getElementById('dep-member').value, a = document.getElementById('dep-amt').value; if(d && a && m) { data.deposits.push({mId: parseInt(m), amt: parseFloat(a), date: d}); window.save(); } };
    window.addMember = function() { if(!isAdmin) return; const n = document.getElementById('new-mem-name').value, m = document.getElementById('new-mem-min').value; if(n) { data.members.push({id: Date.now(), name: n.toUpperCase(), minMeal: parseInt(m) || 50}); window.save(); } };
    window.delMember = function(i) { if(!isAdmin) return; data.members.splice(i, 1); window.save(); };
    window.delBazar = function(i) { if(!isAdmin) return; data.bazar.splice(i, 1); window.save(); };
    window.delDep = function(i) { if(!isAdmin) return; data.deposits.splice(i, 1); window.save(); };
    window.updateKeys = function() { if(!isAdmin) return; keys.admin = document.getElementById('set-admin-key').value.toUpperCase(); keys.viewer = document.getElementById('set-viewer-key').value.toUpperCase(); window.save(); alert("Keys Updated!"); };
    if(localStorage.getItem('isLoggedIn') === 'true') window.login(localStorage.getItem('userRole') === 'admin' ? keys.admin : keys.viewer);
</script>
</body>
</html>
