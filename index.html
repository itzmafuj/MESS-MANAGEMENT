<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mess Buddy | Real-Time Secure</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f43f5e; --accent: #6366f1; --success: #10b981;
            --bg: #f8fafc; --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #0f172a; --text-muted: #64748b;
            --radius-lg: 24px; --radius-md: 16px;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.04), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s ease; }
        body { background: radial-gradient(circle at top right, #fdf2f2, #f8fafc); margin: 0; min-height: 100vh; overflow-x: hidden; }

        #login-screen { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-card { 
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem 2rem; border-radius: var(--radius-lg); width: 90%; max-width: 400px; text-align: center;
        }
        .app-logo { width: 100px; height: 100px; border-radius: 25px; margin-bottom: 1rem; border: 3px solid rgba(255,255,255,0.1); }
        .login-card h2 { color: white; margin: 0; font-size: 1.8rem; }
        .tagline { color: #94a3b8; font-size: 0.9rem; margin: 8px 0 2rem; }

        .edit-input { width: 100%; padding: 1rem; border: 1.5px solid #e2e8f0; border-radius: var(--radius-md); background: white; font-size: 1rem; margin-bottom: 1rem; }
        .login-card .edit-input { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white; text-align: center; }

        .btn { padding: 1rem; border: none; border-radius: var(--radius-md); font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }

        #toast { 
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 1rem 2rem; border-radius: 100px;
            z-index: 3000; box-shadow: 0 10px 15px rgba(0,0,0,0.2); font-weight: bold;
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #toast.show { top: 20px; }

        nav { background: var(--card-bg); backdrop-filter: blur(15px); padding: 0.8rem; display: flex; justify-content: center; gap: 8px; position: sticky; top: 10px; z-index: 1000; margin: 10px 1rem; border-radius: 18px; box-shadow: var(--shadow); }
        nav button { padding: 0.6rem 1rem; border: none; border-radius: 12px; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; }
        nav button.active { background: white; color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .container { max-width: 1000px; margin: 1.5rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); border: 1px solid #f1f5f9; position: relative; }
        
        .notice-card { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; border: none; }
        .notice-text { font-size: 1rem; line-height: 1.5; color: #f1f5f9; font-weight: 600; }

        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { padding: 1.2rem; border-radius: var(--radius-md); color: white; text-align: center; }
        .stat-box h2 { margin: 5px 0 0; font-size: 1.5rem; }

        .blue { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .green { background: linear-gradient(135deg, #10b981, #059669); }
        .gold { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .red { background: linear-gradient(135deg, #f43f5e, #e11d48); }

        .table-wrap { border-radius: var(--radius-md); overflow: hidden; border: 1px solid #f1f5f9; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 1rem; text-align: left; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

        .status-badge { padding: 4px 10px; border-radius: 100px; font-size: 0.65rem; font-weight: 800; display: block; margin-top: 4px; text-align: center; }
        .hidden { display: none !important; }

        .qr-section { background: #fdf2f2; border: 2px dashed var(--primary); border-radius: var(--radius-md); padding: 1.5rem; text-align: center; }
        #display-qr { max-width: 180px; border-radius: 12px; margin: 15px auto; display: block; }

        @media (max-width: 600px) {
            nav { position: fixed; bottom: 10px; top: auto; width: calc(100% - 2rem); margin: 0 1rem; }
            .container { padding-bottom: 80px; }
        }
    </style>
</head>
<body>

<div id="toast">ðŸ”” New Notice Received!</div>

<div id="login-screen">
    <div class="login-card">
        <img src="https://image2url.com/r2/default/images/1770476946953-8102fd3c-bc16-43ef-8b8a-0a4c50759a3c.jpeg" alt="Logo" class="app-logo">
        <h2>Mess Buddy</h2>
        <p class="tagline">"Your Trusted Partner in Every Plate."</p>
        <input type="password" id="pass" placeholder="Enter Key" oninput="autoLogin()" class="edit-input">
        <button class="btn btn-primary" onclick="checkLogin()">Unlock System</button>
    </div>
</div>

<div id="app" style="display:none;">
    <nav>
        <button id="nav-dashboard" class="active" onclick="showTab('dashboard', this)">Home</button>
        <button id="nav-meals" onclick="showTab('meals', this)">Meals</button>
        <button id="nav-bazar" onclick="showTab('bazar', this)">Expenses</button>
        <button id="nav-members" onclick="showTab('members', this)">Team</button>
        <button id="nav-settings" class="admin-only hidden" onclick="showTab('settings', this)">Admin</button>
    </nav>

    <div class="container">
        <div id="tab-dashboard" class="tab-content">
            <div class="card notice-card hidden" id="notice-display-card">
                <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 0.7rem; text-transform: uppercase;">Broadcast Message</h3>
                <div class="notice-text" id="current-notice"></div>
            </div>

            <div class="card">
                <div class="qr-section">
                    <h3 style="margin: 0; color: var(--primary); font-size: 1.1rem;">Scan & Pay Dues</h3>
                    <div id="qr-viewer-area">
                        <div id="no-qr-msg" style="padding:20px; color:#94a3b8;">No QR Uploaded</div>
                        <img id="display-qr" class="hidden" src="" alt="Payment QR">
                        <a id="download-link" class="hidden" href="" download="Mess-Buddy-QR.png" style="text-decoration: none; color: var(--accent); font-weight: 800; font-size: 0.8rem; display: inline-block; margin-top: 10px;">ðŸ“¥ SAVE QR</a>
                    </div>
                </div>
            </div>

            <div class="card" style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h3 id="logic-indicator" style="margin:0; font-size: 0.9rem;">Loading...</h3>
                <div style="display:flex; gap:5px;">
                    <select id="filter-month" class="edit-input" onchange="refreshUI()" style="margin:0; width:110px; padding:5px;"></select>
                    <select id="filter-year" class="edit-input" onchange="refreshUI()" style="margin:0; width:80px; padding:5px;">
                        <option value="2025">2025</option><option value="2026">2026</option>
                    </select>
                </div>
            </div>

            <div class="grid-stats">
                <div class="stat-box blue"><span>Total Meals</span><h2 id="stat-meals">0</h2></div>
                <div class="stat-box green"><span>Total Cost</span><h2 id="stat-cost">â‚¹0</h2></div>
                <div class="stat-box gold" id="balance-card"><span>Cash flow</span><h2 id="stat-balance">â‚¹0</h2></div>
                <div class="stat-box red"><span>Meal Rate</span><h2 id="stat-rate">â‚¹0</h2></div>
            </div>

            <div class="card">
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Member</th><th>Deposit</th><th>Meals</th><th>Cost</th><th>Status</th></tr></thead>
                        <tbody id="summary-body"></tbody>
                    </table>
                </div>
            </div>
            <button class="btn" style="background:#e2e8f0; margin-bottom: 2rem;" onclick="logout()">Lock System</button>
        </div>

        <div id="tab-meals" class="tab-content hidden">
            <div class="card admin-only hidden">
                <h3>Daily Entry</h3>
                <input type="date" id="meal-date" class="edit-input">
                <div id="meal-inputs-area"></div>
                <button class="btn btn-primary" onclick="saveDailyMeals()">Save Record</button>
            </div>
            <div class="card"><div class="table-wrap"><table><thead id="meal-history-head"></thead><tbody id="meal-history-body"></tbody></table></div></div>
        </div>

        <div id="tab-bazar" class="tab-content hidden">
            <div class="card admin-only hidden"><h3>Add Expense</h3><input type="date" id="b-date" class="edit-input"><input type="number" id="b-amt" placeholder="Amount" class="edit-input"><input type="text" id="b-note" placeholder="Item" class="edit-input"><button class="btn btn-primary" onclick="addBazar()">Add Expense</button></div>
            <div class="card"><div class="table-wrap"><table><tbody id="bazar-body"></tbody></table></div></div>
        </div>

        <div id="tab-members" class="tab-content hidden">
            <div class="card admin-only hidden"><h3>Members</h3><input type="text" id="new-mem-name" class="edit-input" placeholder="Name"><input type="number" id="new-mem-min" class="edit-input" placeholder="Min Meal" value="50"><button class="btn btn-primary" onclick="addMember()">Add Member</button><hr style="margin:1.5rem 0; border:0; border-top:1px solid #eee;"><input type="date" id="dep-date" class="edit-input"><select id="dep-member" class="edit-input"></select><input type="number" id="dep-amt" placeholder="Deposit Amount" class="edit-input"><button class="btn btn-primary" onclick="addDeposit()">Save Deposit</button></div>
            <div class="card"><div class="table-wrap"><table><tbody id="member-list-body"></tbody></table></div></div>
            <div class="card"><div class="table-wrap"><table><tbody id="deposit-history-body"></tbody></table></div></div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <div class="card admin-only hidden">
                <h3>Notice Management</h3>
                <textarea id="notice-input" class="edit-input" placeholder="Type new notice here..." style="height: 100px; resize: none;"></textarea>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" style="background: var(--accent);" onclick="updateNotice()">Broadcast</button>
                    <button class="btn" style="background: #fee2e2; color: #ef4444;" onclick="clearNotice()">Clear Current</button>
                </div>
            </div>
            <div class="card">
                <h3>System Keys</h3>
                <input type="text" id="set-admin-key" class="edit-input" placeholder="Admin Key"><input type="text" id="set-viewer-key" class="edit-input" placeholder="Viewer Key"><button class="btn btn-primary" onclick="updateKeys()">Save Security</button>
            </div>
            <div class="card admin-only hidden"><h3>Payment QR</h3><input type="file" id="qr-input" accept="image/*"><button class="btn btn-primary" onclick="uploadQR()">Push QR Live</button></div>
        </div>
    </div>
</div>

<script>
    let isAdmin = false;
    let lastKnownNotice = "";
    let keys = JSON.parse(localStorage.getItem('messKeys')) || { admin: "MESS2026", viewer: "MESSMEAL" };
    let data = { members: [], meals: {}, bazar: [], deposits: [], keys: keys, paymentQR: "", notice: "" };
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAnfWzHfN2qBGw68lOkTttSZ3Mz3D0T274",
        authDomain: "messmenegment.firebaseapp.com",
        databaseURL: "https://messmenegment-default-rtdb.firebaseio.com",
        projectId: "messmenegment",
        storageBucket: "messmenegment.firebasestorage.app",
        messagingSenderId: "365715103776",
        appId: "1:365715103776:web:32af4ed2537cb806341c45"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dataRef = ref(db, 'messData');

    onValue(dataRef, (snapshot) => {
        const cloudData = snapshot.val();
        if (cloudData) {
            // Instant Notification Logic
            if (cloudData.notice && cloudData.notice !== lastKnownNotice && lastKnownNotice !== "") {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 6000);
            }
            lastKnownNotice = cloudData.notice || "";
            
            data = cloudData;
            if (data.keys) { keys = data.keys; localStorage.setItem('messKeys', JSON.stringify(keys)); }
            window.refreshUI();
            window.refreshQR();
            window.refreshNotice();
        }
    });

    window.save = function() {
        if(!isAdmin) return;
        data.keys = keys;
        set(dataRef, data);
        window.refreshUI();
    };

    window.updateNotice = function() {
        const t = document.getElementById('notice-input').value;
        if(t) { data.notice = t; window.save(); document.getElementById('notice-input').value = ""; }
    };

    window.clearNotice = function() { data.notice = ""; window.save(); };

    window.refreshNotice = function() {
        const d = document.getElementById('notice-display-card');
        const t = document.getElementById('current-notice');
        if(data.notice) { t.innerText = data.notice; d.classList.remove('hidden'); }
        else { d.classList.add('hidden'); }
    };

    window.uploadQR = function() {
        const file = document.getElementById('qr-input').files[0];
        if(!file) return;
        const r = new FileReader();
        r.onloadend = () => { data.paymentQR = r.result; window.save(); };
        r.readAsDataURL(file);
    };

    window.refreshQR = function() {
        const i = document.getElementById('display-qr'), l = document.getElementById('download-link'), m = document.getElementById('no-qr-msg');
        if(data.paymentQR) { i.src = data.paymentQR; i.classList.remove('hidden'); l.href = data.paymentQR; l.classList.remove('hidden'); m.classList.add('hidden'); }
        else { i.classList.add('hidden'); l.classList.add('hidden'); m.classList.remove('hidden'); }
    };

    window.refreshUI = function() {
        const sBody = document.getElementById('summary-body');
        if(!sBody) return;
        const selMonth = document.getElementById('filter-month').value, selYear = document.getElementById('filter-year').value;
        const filterStr = `${selYear}-${selMonth}`;
        const lastDayDate = new Date(selYear, selMonth, 0); 
        const lastDayString = `${selYear}-${selMonth}-${String(lastDayDate.getDate()).padStart(2, '0')}`;
        const isFinished = data.meals && data.meals[lastDayString];

        document.getElementById('logic-indicator').innerText = isFinished ? "â— Settlement Mode" : "â— Tracking Mode";
        document.getElementById('logic-indicator').style.color = isFinished ? "var(--success)" : "var(--warning)";

        let totalBillable = 0, mActualCounts = {}, mDepsSum = {}, periodIncome = 0;
        (data.members || []).forEach(m => { mActualCounts[m.id] = 0; mDepsSum[m.id] = 0; });
        (data.deposits || []).forEach(d => { if(d.date?.startsWith(filterStr)) { mDepsSum[d.mId] += parseFloat(d.amt); periodIncome += parseFloat(d.amt); } });
        
        if (data.meals) {
            Object.entries(data.meals).forEach(([date, entry]) => {
                if(date.startsWith(filterStr)) {
                    Object.entries(entry).forEach(([id, qty]) => { if(mActualCounts[id] !== undefined) mActualCounts[id] += parseInt(qty) || 0; });
                }
            });
        }

        const calcData = (data.members || []).map(m => {
            const actual = mActualCounts[m.id] || 0, minSet = m.minMeal || 50;
            const billable = isFinished ? (actual <= minSet ? minSet : actual) : actual;
            totalBillable += billable;
            return { ...m, actual, billable, minSet };
        });

        const totalBazar = (data.bazar || []).reduce((sum, b) => b.date?.startsWith(filterStr) ? sum + parseFloat(b.amt) : sum, 0);
        const rate = totalBillable > 0 ? totalBazar / totalBillable : 0;
        const avail = periodIncome - totalBazar;

        document.getElementById('stat-meals').innerText = Math.floor(totalBillable);
        document.getElementById('stat-cost').innerText = "â‚¹" + totalBazar.toLocaleString();
        document.getElementById('stat-balance').innerText = "â‚¹" + avail.toLocaleString();
        document.getElementById('stat-rate').innerText = "â‚¹" + rate.toFixed(2);

        sBody.innerHTML = calcData.map(m => {
            const cost = m.billable * rate, net = cost - (mDepsSum[m.id] || 0);
            return `<tr><td><b>${m.name}</b></td><td>â‚¹${(mDepsSum[m.id] || 0)}</td><td>${m.actual} <small>/${m.minSet}</small></td><td>â‚¹${cost.toFixed(0)}</td><td><b style="color:${net > 0 ? 'var(--primary)' : 'var(--success)'}">â‚¹${Math.abs(net).toFixed(0)}</b><span class="status-badge" style="background:${net > 0 ? '#fff1f2' : '#ecfdf5'}; color:${net > 0 ? 'var(--primary)' : 'var(--success)'}">${net > 0 ? 'DUE' : 'SURPLUS'}</span></td></tr>`;
        }).join('');

        document.getElementById('dep-member').innerHTML = (data.members || []).map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        if(isAdmin) {
            document.getElementById('meal-inputs-area').innerHTML = (data.members || []).map(m => `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #eef2f6;"><b>${m.name}</b><input type="number" class="day-meal-val edit-input" style="width:70px; margin:0; text-align:center;" data-id="${m.id}" value="0"></div>`).join('');
        }
        
        const mDates = Object.keys(data.meals || {}).sort().reverse();
        document.getElementById('meal-history-head').innerHTML = `<tr><th>Date</th>${(data.members || []).map(m => `<th>${m.name.substring(0,3)}</th>`).join('')}${isAdmin ? '<th></th>' : ''}</tr>`;
        document.getElementById('meal-history-body').innerHTML = mDates.map(d => `<tr><td><small>${d}</small></td>${(data.members || []).map(m => `<td>${Math.floor(data.meals[d][m.id] || 0)}</td>`).join('')}${isAdmin ? `<td><button onclick="delMealDate('${d}')">âœ•</button></td>` : ''}</tr>`).join('');
        document.getElementById('bazar-body').innerHTML = (data.bazar || []).slice().reverse().map((b, i) => `<tr><td>${b.date}</td><td>${b.note}</td><td>â‚¹${b.amt}</td>${isAdmin ? `<td><button onclick="delBazar(${data.bazar.length-1-i})">âœ•</button></td>` : ''}</tr>`).join('');
        document.getElementById('member-list-body').innerHTML = (data.members || []).map((m, i) => `<tr><td><b>${m.name}</b></td><td>Min: ${m.minMeal}</td>${isAdmin ? `<td><button onclick="delMember(${i})">âœ•</button></td>` : ''}</tr>`).join('');
        document.getElementById('deposit-history-body').innerHTML = (data.deposits || []).slice().reverse().map((d, i) => {
            const m = data.members.find(mem => mem.id == d.mId);
            return `<tr><td>${d.date}</td><td>${m ? m.name : '?'}</td><td>â‚¹${d.amt}</td>${isAdmin ? `<td><button onclick="delDep(${data.deposits.length-1-i})">âœ•</button></td>` : ''}</tr>`;
        }).join('');
    };

    window.showTab = function(id, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        window.refreshUI();
    };

    window.login = function(key) {
        isAdmin = (key === keys.admin);
        document.getElementById('login-screen').style.display = 'none'; 
        document.getElementById('app').style.display = 'block';
        document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
        const now = new Date();
        const mSelect = document.getElementById('filter-month');
        if(mSelect.options.length === 0) {
            mSelect.innerHTML = ['January','February','March','April','May','June','July','August','September','October','November','December'].map((m, i) => `<option value="${String(i+1).padStart(2,'0')}">${m}</option>`).join('');
            mSelect.value = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('filter-year').value = now.getFullYear();
        }
        window.refreshUI(); window.refreshQR(); window.refreshNotice();
    };

    window.autoLogin = function() { const v = document.getElementById('pass').value.toUpperCase(); if(v === keys.admin || v === keys.viewer) window.login(v); };
    window.checkLogin = function() { const v = document.getElementById('pass').value.toUpperCase(); if(v === keys.admin || v === keys.viewer) window.login(v); else alert("Wrong Key"); };
    window.logout = function() { location.reload(); };

    window.saveDailyMeals = function() { if(!isAdmin) return; const d = document.getElementById('meal-date').value; if(!d) return; const entry = {}; document.querySelectorAll('.day-meal-val').forEach(i => entry[i.dataset.id] = parseInt(i.value) || 0); if(!data.meals) data.meals = {}; data.meals[d] = entry; window.save(); };
    window.delMealDate = function(d) { if(!isAdmin) return; if(confirm("Delete?")) { delete data.meals[d]; window.save(); } };
    window.addBazar = function() { if(!isAdmin) return; const d = document.getElementById('b-date').value, a = document.getElementById('b-amt').value; if(d && a) { if(!data.bazar) data.bazar = []; data.bazar.push({amt: parseFloat(a), note: document.getElementById('b-note').value, date: d}); window.save(); } };
    window.addDeposit = function() { if(!isAdmin) return; const d = document.getElementById('dep-date').value, m = document.getElementById('dep-member').value, a = document.getElementById('dep-amt').value; if(d && a && m) { if(!data.deposits) data.deposits = []; data.deposits.push({mId: parseInt(m), amt: parseFloat(a), date: d}); window.save(); } };
    window.addMember = function() { if(!isAdmin) return; const n = document.getElementById('new-mem-name').value, m = document.getElementById('new-mem-min').value; if(n) { if(!data.members) data.members = []; data.members.push({id: Date.now(), name: n.toUpperCase(), minMeal: parseInt(m) || 50}); window.save(); } };
    window.delMember = function(i) { if(!isAdmin) return; data.members.splice(i, 1); window.save(); };
    window.delBazar = function(i) { if(!isAdmin) return; data.bazar.splice(i, 1); window.save(); };
    window.delDep = function(i) { if(!isAdmin) return; data.deposits.splice(i, 1); window.save(); };
    window.updateKeys = function() { if(!isAdmin) return; keys.admin = document.getElementById('set-admin-key').value.toUpperCase(); keys.viewer = document.getElementById('set-viewer-key').value.toUpperCase(); window.save(); alert("Keys Updated!"); };
</script>
</body>
</html>
